name: JMeter Test using PerfAction

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  run-jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Apache JMeter
        run: |
          wget https://downloads.apache.org/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xvzf apache-jmeter-5.6.3.tgz
          echo "JMETER_HOME=$PWD/apache-jmeter-5.6.3" >> $GITHUB_ENV
          echo "$PWD/apache-jmeter-5.6.3/bin" >> $GITHUB_PATH

      - name: Create custom JMeter properties file
        run: |
          echo "jmeter.reportgenerator.exporter.html.property.graph.responseTimeDistribution.intervals=0,100,500,1000,2000" > custom.properties
          echo "jmeter.reportgenerator.exporter.html.series_filter=.*" >> custom.properties
          echo "jmeter.reportgenerator.exporter.html.filters_only_sample_series=false" >> custom.properties
          echo "jmeter.reportgenerator.overall_granularity=60000" >> custom.properties

      - name: Run JMeter test with PerfAction
        uses: QAInsights/PerfAction@v5.6.3
        with:
          test-plan-path: './les-recoltes---calendrier.jmx'
          results-file: './resultat1.jtl'
          args: '-n -t les-recoltes---calendrier.jmx -l resultat1.jtl -j jmeter.log'

      - name: Show JMeter log for debugging
        run: cat jmeter.log

      - name: Check if JTL file is empty (fail early)
        run: |
          if [ ! -s resultat1.jtl ]; then
            echo "❌ Le fichier resultat1.jtl est vide ! Le test JMeter a probablement échoué."
            exit 1
          fi

      - name: Generate HTML Report from JTL with custom properties
        run: |
          mkdir -p jmeter-report
          jmeter -g resultat1.jtl -o jmeter-report -q custom.properties

      - name: Generate test summary
        run: |
          echo "## Résumé JMeter" > summary.md
          echo "Date du test : $(date)" >> summary.md
          echo "\nNombre total de lignes dans le fichier JTL :" >> summary.md
          wc -l < resultat1.jtl >> summary.md

      - name: Upload JTL result file
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-result-jtl
          path: resultat1.jtl

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-report
          path: jmeter-report/

      - name: Upload Test Summary
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-summary
          path: summary.md
